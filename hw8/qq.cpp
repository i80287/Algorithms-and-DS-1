
[[maybe_unused]] static void transpose_slow(bitset<4096> (&m)[4096]) {
    for (size_t i = 0; i < 4096; i++) {
        for (size_t j = i + 1; j < 4096; j++) {
            bool mij = m[i][j];
            bool mji = m[j][i];
            m[i][j]  = mji;
            m[j][i]  = mij;
        }
    }
}

template <std::size_t N>
#if defined(__cpp_concepts) && __cpp_concepts >= 201907L
    requires(N * 64 <= 4096)
#endif
[[maybe_unused]] static void set_u64_matrix(bitset<4096> (&m)[4096],
                                            const uint64_t (&m_u64)[N * 64][N]) {
    for (size_t i = 0; i < N * 64; i++) {
        uint64_t* m_ptr = reinterpret_cast<uint64_t*>(&m[i]);
        std::copy(&m_u64[i][0], &m_u64[i][N], &m_ptr[0]);
    }
}

[[maybe_unused]] static void test() {
    constexpr uint64_t m_u64_1[][2] = {
        {18446744073709551557ull, 18446744073709551533ull},
        {18446744073709551521ull, 18446744073709551437ull},
        {18446744073709551427ull, 18446744073709551359ull},
        {18446744073709551337ull, 18446744073709551293ull},
        {18446744073709551263ull, 18446744073709551253ull},
        {18446744073709551191ull, 18446744073709551163ull},
        {18446744073709551113ull, 18446744073709550873ull},
        {18446744073709550791ull, 18446744073709550773ull},
        {18446744073709550771ull, 18446744073709550719ull},
        {18446744073709550717ull, 18446744073709550681ull},
        {18446744073709550671ull, 18446744073709550593ull},
        {18446744073709550591ull, 18446744073709550539ull},
        {18446744073709550537ull, 18446744073709550381ull},
        {18446744073709550341ull, 18446744073709550293ull},
        {18446744073709550237ull, 18446744073709550147ull},
        {18446744073709550141ull, 18446744073709550129ull},
        {18446744073709550111ull, 18446744073709550099ull},
        {18446744073709550047ull, 18446744073709550033ull},
        {18446744073709550009ull, 18446744073709549951ull},
        {18446744073709549861ull, 18446744073709549817ull},
        {18446744073709549811ull, 18446744073709549777ull},
        {18446744073709549757ull, 18446744073709549733ull},
        {18446744073709549667ull, 18446744073709549621ull},
        {18446744073709549613ull, 18446744073709549583ull},
        {18446744073709549571ull, 18446744073709549519ull},
        {18446744073709549483ull, 18446744073709549441ull},
        {18446744073709549363ull, 18446744073709549331ull},
        {18446744073709549327ull, 18446744073709549307ull},
        {18446744073709549237ull, 18446744073709549153ull},
        {18446744073709549123ull, 18446744073709549067ull},
        {18446744073709549061ull, 18446744073709549019ull},
        {18446744073709548983ull, 18446744073709548899ull},
        {18446744073709548887ull, 18446744073709548859ull},
        {18446744073709548847ull, 18446744073709548809ull},
        {18446744073709548703ull, 18446744073709548599ull},
        {18446744073709548587ull, 18446744073709548557ull},
        {18446744073709548511ull, 18446744073709548503ull},
        {18446744073709548497ull, 18446744073709548481ull},
        {18446744073709548397ull, 18446744073709548391ull},
        {18446744073709548379ull, 18446744073709548353ull},
        {18446744073709548349ull, 18446744073709548287ull},
        {18446744073709548271ull, 18446744073709548239ull},
        {18446744073709548193ull, 18446744073709548119ull},
        {18446744073709548073ull, 18446744073709548053ull},
        {18446744073709547821ull, 18446744073709547797ull},
        {18446744073709547777ull, 18446744073709547731ull},
        {18446744073709547707ull, 18446744073709547669ull},
        {18446744073709547657ull, 18446744073709547537ull},
        {18446744073709547521ull, 18446744073709547489ull},
        {18446744073709547473ull, 18446744073709547471ull},
        {18446744073709547371ull, 18446744073709547357ull},
        {18446744073709547317ull, 18446744073709547303ull},
        {18446744073709547117ull, 18446744073709547087ull},
        {18446744073709547003ull, 18446744073709546897ull},
        {18446744073709546879ull, 18446744073709546873ull},
        {18446744073709546841ull, 18446744073709546739ull},
        {18446744073709546729ull, 18446744073709546657ull},
        {18446744073709546643ull, 18446744073709546601ull},
        {18446744073709546561ull, 18446744073709546541ull},
        {18446744073709546493ull, 18446744073709546429ull},
        {18446744073709546409ull, 18446744073709546391ull},
        {18446744073709546363ull, 18446744073709546337ull},
        {18446744073709546333ull, 18446744073709546289ull},
        {18446744073709546271ull, 18446744073709546253ull},
        {18446744073709546247ull, 18446744073709546093ull},
        {18446744073709546079ull, 18446744073709546027ull},
        {18446744073709545953ull, 18446744073709545911ull},
        {18446744073709545871ull, 18446744073709545817ull},
        {18446744073709545809ull, 18446744073709545779ull},
        {18446744073709545743ull, 18446744073709545697ull},
        {18446744073709545689ull, 18446744073709545677ull},
        {18446744073709545673ull, 18446744073709545661ull},
        {18446744073709545577ull, 18446744073709545533ull},
        {18446744073709545421ull, 18446744073709545233ull},
        {18446744073709545229ull, 18446744073709545169ull},
        {18446744073709545109ull, 18446744073709544947ull},
        {18446744073709544941ull, 18446744073709544839ull},
        {18446744073709544717ull, 18446744073709544699ull},
        {18446744073709544633ull, 18446744073709544627ull},
        {18446744073709544623ull, 18446744073709544591ull},
        {18446744073709544581ull, 18446744073709544573ull},
        {18446744073709544539ull, 18446744073709544449ull},
        {18446744073709544399ull, 18446744073709544279ull},
        {18446744073709544269ull, 18446744073709544221ull},
        {18446744073709544039ull, 18446744073709544003ull},
        {18446744073709543937ull, 18446744073709543919ull},
        {18446744073709543913ull, 18446744073709543901ull},
        {18446744073709543807ull, 18446744073709543751ull},
        {18446744073709543699ull, 18446744073709543639ull},
        {18446744073709543573ull, 18446744073709543463ull},
        {18446744073709543309ull, 18446744073709543297ull},
        {18446744073709543259ull, 18446744073709543223ull},
        {18446744073709543187ull, 18446744073709543159ull},
        {18446744073709543127ull, 18446744073709543117ull},
        {18446744073709543069ull, 18446744073709543027ull},
        {18446744073709542991ull, 18446744073709542989ull},
        {18446744073709542959ull, 18446744073709542953ull},
        {18446744073709542937ull, 18446744073709542881ull},
        {18446744073709542869ull, 18446744073709542853ull},
        {18446744073709542793ull, 18446744073709542751ull},
        {18446744073709542719ull, 18446744073709542713ull},
        {18446744073709542629ull, 18446744073709542583ull},
        {18446744073709542553ull, 18446744073709542527ull},
        {18446744073709542499ull, 18446744073709542467ull},
        {18446744073709542463ull, 18446744073709542443ull},
        {18446744073709542259ull, 18446744073709541893ull},
        {18446744073709541851ull, 18446744073709541813ull},
        {18446744073709541783ull, 18446744073709541753ull},
        {18446744073709541747ull, 18446744073709541621ull},
        {18446744073709541539ull, 18446744073709541519ull},
        {18446744073709541489ull, 18446744073709541459ull},
        {18446744073709541411ull, 18446744073709541257ull},
        {18446744073709541209ull, 18446744073709541203ull},
        {18446744073709541171ull, 18446744073709541119ull},
        {18446744073709541113ull, 18446744073709541069ull},
        {18446744073709540993ull, 18446744073709540951ull},
        {18446744073709540913ull, 18446744073709540907ull},
        {18446744073709540793ull, 18446744073709540753ull},
        {18446744073709540723ull, 18446744073709540709ull},
        {18446744073709540649ull, 18446744073709540469ull},
        {18446744073709540451ull, 18446744073709540441ull},
        {18446744073709540423ull, 18446744073709540403ull},
        {18446744073709540357ull, 18446744073709540291ull},
        {18446744073709540279ull, 18446744073709540247ull},
        {18446744073709540207ull, 18446744073709540201ull},
        {18446744073709540093ull, 18446744073709540063ull},
        {18446744073709540049ull, 18446744073709540013ull},
        {18446744073709539937ull, 18446744073709539871ull},
    };
    constexpr uint64_t m_u64_2[][2] = {
        {18446744073709539839ull, 18446744073709539689ull},
        {18446744073709539683ull, 18446744073709539611ull},
        {18446744073709539593ull, 18446744073709539551ull},
        {18446744073709539503ull, 18446744073709539421ull},
        {18446744073709539403ull, 18446744073709539361ull},
        {18446744073709539337ull, 18446744073709539229ull},
        {18446744073709539127ull, 18446744073709539109ull},
        {18446744073709539031ull, 18446744073709539017ull},
        {18446744073709539011ull, 18446744073709538941ull},
        {18446744073709538893ull, 18446744073709538819ull},
        {18446744073709538773ull, 18446744073709538747ull},
        {18446744073709538723ull, 18446744073709538677ull},
        {18446744073709538621ull, 18446744073709538567ull},
        {18446744073709538501ull, 18446744073709538459ull},
        {18446744073709538449ull, 18446744073709538443ull},
        {18446744073709538437ull, 18446744073709538393ull},
        {18446744073709538347ull, 18446744073709538317ull},
        {18446744073709538273ull, 18446744073709538183ull},
        {18446744073709538179ull, 18446744073709538123ull},
        {18446744073709538101ull, 18446744073709538023ull},
        {18446744073709537909ull, 18446744073709537871ull},
        {18446744073709537853ull, 18446744073709537849ull},
        {18446744073709537841ull, 18446744073709537837ull},
        {18446744073709537823ull, 18446744073709537793ull},
        {18446744073709537763ull, 18446744073709537723ull},
        {18446744073709537673ull, 18446744073709537633ull},
        {18446744073709537589ull, 18446744073709537499ull},
        {18446744073709537457ull, 18446744073709537447ull},
        {18446744073709537409ull, 18446744073709537331ull},
        {18446744073709537253ull, 18446744073709537241ull},
        {18446744073709537231ull, 18446744073709537219ull},
        {18446744073709537153ull, 18446744073709537129ull},
        {18446744073709537111ull, 18446744073709537109ull},
        {18446744073709537043ull, 18446744073709536997ull},
        {18446744073709536967ull, 18446744073709536863ull},
        {18446744073709536803ull, 18446744073709536727ull},
        {18446744073709536719ull, 18446744073709536707ull},
        {18446744073709536631ull, 18446744073709536577ull},
        {18446744073709536509ull, 18446744073709536491ull},
        {18446744073709536469ull, 18446744073709536463ull},
        {18446744073709536427ull, 18446744073709536401ull},
        {18446744073709536329ull, 18446744073709536259ull},
        {18446744073709536191ull, 18446744073709536161ull},
        {18446744073709536157ull, 18446744073709536073ull},
        {18446744073709536071ull, 18446744073709535783ull},
        {18446744073709535777ull, 18446744073709535741ull},
        {18446744073709535711ull, 18446744073709535621ull},
        {18446744073709535603ull, 18446744073709535587ull},
        {18446744073709535543ull, 18446744073709535531ull},
        {18446744073709535473ull, 18446744073709535471ull},
        {18446744073709535461ull, 18446744073709535417ull},
        {18446744073709535399ull, 18446744073709535359ull},
        {18446744073709535267ull, 18446744073709535239ull},
        {18446744073709535237ull, 18446744073709535113ull},
        {18446744073709535041ull, 18446744073709535039ull},
        {18446744073709534987ull, 18446744073709534963ull},
        {18446744073709534951ull, 18446744073709534937ull},
        {18446744073709534883ull, 18446744073709534837ull},
        {18446744073709534823ull, 18446744073709534811ull},
        {18446744073709534787ull, 18446744073709534753ull},
        {18446744073709534673ull, 18446744073709534589ull},
        {18446744073709534573ull, 18446744073709534529ull},
        {18446744073709534441ull, 18446744073709534439ull},
        {18446744073709534403ull, 18446744073709534393ull},
        {18446744073709534391ull, 18446744073709534301ull},
        {18446744073709534273ull, 18446744073709534097ull},
        {18446744073709534091ull, 18446744073709534087ull},
        {18446744073709533991ull, 18446744073709533941ull},
        {18446744073709533917ull, 18446744073709533913ull},
        {18446744073709533851ull, 18446744073709533797ull},
        {18446744073709533719ull, 18446744073709533679ull},
        {18446744073709533607ull, 18446744073709533599ull},
        {18446744073709533521ull, 18446744073709533497ull},
        {18446744073709533469ull, 18446744073709533349ull},
        {18446744073709533277ull, 18446744073709533259ull},
        {18446744073709533247ull, 18446744073709533173ull},
        {18446744073709533163ull, 18446744073709533133ull},
        {18446744073709533103ull, 18446744073709533097ull},
        {18446744073709533053ull, 18446744073709532891ull},
        {18446744073709532837ull, 18446744073709532761ull},
        {18446744073709532753ull, 18446744073709532747ull},
        {18446744073709532683ull, 18446744073709532467ull},
        {18446744073709532443ull, 18446744073709532393ull},
        {18446744073709532297ull, 18446744073709532281ull},
        {18446744073709532279ull, 18446744073709532261ull},
        {18446744073709532173ull, 18446744073709532159ull},
        {18446744073709532153ull, 18446744073709532117ull},
        {18446744073709531919ull, 18446744073709531913ull},
        {18446744073709531907ull, 18446744073709531873ull},
        {18446744073709531823ull, 18446744073709531781ull},
        {18446744073709531777ull, 18446744073709531771ull},
        {18446744073709531753ull, 18446744073709531751ull},
        {18446744073709531717ull, 18446744073709531703ull},
        {18446744073709531681ull, 18446744073709531627ull},
        {18446744073709531621ull, 18446744073709531607ull},
        {18446744073709531571ull, 18446744073709531549ull},
        {18446744073709531529ull, 18446744073709531507ull},
        {18446744073709531493ull, 18446744073709531343ull},
        {18446744073709531313ull, 18446744073709531201ull},
        {18446744073709531189ull, 18446744073709531123ull},
        {18446744073709531093ull, 18446744073709530947ull},
        {18446744073709530941ull, 18446744073709530919ull},
        {18446744073709530899ull, 18446744073709530823ull},
        {18446744073709530713ull, 18446744073709530653ull},
        {18446744073709530599ull, 18446744073709530587ull},
        {18446744073709530563ull, 18446744073709530539ull},
        {18446744073709530511ull, 18446744073709530461ull},
        {18446744073709530431ull, 18446744073709530317ull},
        {18446744073709530287ull, 18446744073709530259ull},
        {18446744073709530211ull, 18446744073709530199ull},
        {18446744073709529983ull, 18446744073709529953ull},
        {18446744073709529887ull, 18446744073709529881ull},
        {18446744073709529867ull, 18446744073709529797ull},
        {18446744073709529789ull, 18446744073709529741ull},
        {18446744073709529707ull, 18446744073709529693ull},
        {18446744073709529573ull, 18446744073709529531ull},
        {18446744073709529503ull, 18446744073709529443ull},
        {18446744073709529411ull, 18446744073709529377ull},
        {18446744073709529353ull, 18446744073709529119ull},
        {18446744073709529089ull, 18446744073709529033ull},
        {18446744073709528981ull, 18446744073709528961ull},
        {18446744073709528883ull, 18446744073709528781ull},
        {18446744073709528747ull, 18446744073709528669ull},
        {18446744073709528637ull, 18446744073709528477ull},
        {18446744073709528429ull, 18446744073709528397ull},
        {18446744073709528349ull, 18446744073709528303ull},
        {18446744073709528289ull, 18446744073709528259ull},
        {18446744073709528211ull, 18446744073709528193ull},
    };

    set_u64_matrix(m_a, m_u64_1);
    set_u64_matrix(m_b, m_u64_2);

    auto print = [](string_view name, const std::bitset<4096>(&m)[4096]) {
        cout << name << " = np.array([\n";
        for (size_t i = 0; i < 128; i++) {
            cout << "    [";
            for (size_t j = 0; j < 128; j++) {
                cout << m[i][j];
                if (j != 127) {
                    cout << ", ";
                }
            }
            cout << "],\n";
        }
        cout << "], dtype=np.uint32)\n";
    };

    print("A", m_a);
    print("B", m_b);

    transpose_m(m_b);
    bitset<4096> tmp;
    for (size_t i = 0; i < 4096; i++) {
        for (size_t j = 0; j < 4096; j++) {
            tmp = m_a[i];
            tmp &= m_b[j];
            m_c[i][j] = bool(tmp.count() % 2);
        }
    }
    print("C", m_c);
}
